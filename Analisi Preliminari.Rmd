---
title: "Prime analisi"
author: "Mariateresa Russo"
date: "2025-05-31"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(stringr)
library(tm)
library(plotly)
library(ggplot2)
library(igraph)

df_new_comments = read.csv("nutrition_comments_cleaned.csv")
df_new_threads = read.csv("nutrition_threads_cleaned.csv")
```

Autori che postano di più e autori che commentano di più
```{r}
# Conteggio thread per autore
threads_by_author <- df_new_threads %>%
  group_by(author) %>%
  summarise(n_threads = n()) %>%
  arrange(desc(n_threads))

threads_by_author

# Conteggio commenti per autore
comments_by_author <- df_new_comments %>%
  group_by(author) %>%
  summarise(n_comments = n()) %>%
  arrange(desc(n_comments))

comments_by_author
```

```{r}
# Prendi i primi 20 autori con più thread
df_top_authors_threads <- threads_by_author %>%
  slice_max(n_threads, n = 20)

# Crea il grafico a barre orizzontali
plot_ly(
  df_top_authors_threads,
  x = ~n_threads,
  y = ~reorder(author, n_threads),
  type = "bar",
  orientation = "h",
  marker = list(color = "orange")
) %>%
  layout(
    title = "Top 20 autori per numero di thread",
    xaxis = list(title = "Numero di thread"),
    yaxis = list(title = "Autori"),
    margin = list(l = 200)
  )

```
```{r}
# Prendi i primi 20 autori con più commenti
df_top_authors_comments <- comments_by_author %>%
  filter(author != "[deleted]") %>%
  slice_max(n_comments, n = 20)

# Crea il grafico a barre orizzontali
plot_ly(
  df_top_authors_comments,
  x = ~n_comments,
  y = ~reorder(author, n_comments),
  type = "bar",
  orientation = "h",
  marker = list(color = "yellow")
) %>%
  layout(
    title = "Top 20 autori per numero di commenti",
    xaxis = list(title = "Numero di commenti"),
    yaxis = list(title = "Autori"),
    margin = list(l = 200)
  )
```

Autori che interagiscono tra loro PROVATE CON DIVERSI PACCHETTI PER LE RETI:gggraph visNetwork Networkd3 ecc.
```{r}
library(dplyr)
library(tidyr)

# Pulisci i commenti: rimuovi [deleted] e crea il "gruppo" della conversazione
df_clean <- df_new_comments %>%
  filter(author != "[deleted]") %>%
  mutate(comment_group = sub("_.*", "", comment_id))  # es. da "2_1_3" ottieni "2"

# Costruisci le coppie autore-autore per ogni gruppo thread+comment_group
co_commenters <- df_clean %>%
  select(thread, comment_group, author) %>%
  distinct() %>%
  group_by(thread, comment_group) %>%
  filter(n_distinct(author) > 1) %>%
  summarise(pairs = list(as.data.frame(t(combn(sort(unique(author)), 2)))), .groups = "drop") %>%
  unnest(pairs) %>%
  rename(Source = V1, Target = V2) %>%
  group_by(Source, Target) %>%
  summarise(weight = n(), .groups = "drop")

# Esporta per Gephi
write.csv(co_commenters, "comment_network_edges.csv", row.names = FALSE)

# Nodi
nodes <- unique(c(co_commenters$Source, co_commenters$Target))
nodes_df <- data.frame(Id = nodes, Label = nodes)
write.csv(nodes_df, "comment_network_nodes.csv", row.names = FALSE)

```

```{r}
# Filtra archi per peso
filtered_edges <- co_commenters %>% filter(weight >= 5)

# Crea grafo
g <- graph_from_data_frame(filtered_edges, directed = FALSE)

# Ricalcola layout
layout <- layout_with_graphopt(g)
layout_df <- as.data.frame(layout)
colnames(layout_df) <- c("x", "y")
layout_df$label <- V(g)$name
deg <- degree(g)
layout_df$size <- scales::rescale(deg, to = c(5, 15))  # dimensione proporzionale

# Edges
edges <- get.edgelist(g, names = FALSE)
edges_df <- data.frame(
  x = layout_df$x[edges[,1]],
  y = layout_df$y[edges[,1]],
  xend = layout_df$x[edges[,2]],
  yend = layout_df$y[edges[,2]]
)

# Visualizzazione plotly
plot_ly() %>%
  add_segments(
    data = edges_df,
    x = ~x, y = ~y, xend = ~xend, yend = ~yend,
    line = list(color = 'rgba(150,150,150,0.2)', width = 0.5),
    hoverinfo = 'none',
    showlegend = FALSE
  ) %>%
  add_trace(
    data = layout_df,
    x = ~x, y = ~y,
    type = 'scatter', mode = 'markers+text',
    text = ~label,
    hoverinfo = 'text',
    marker = list(size = ~size, color = 'red', opacity = 0.8),
    textposition = 'top center'
  ) %>%
  layout(
    title = "Filtered Co-commenters Network (weight ≥ 5)",
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    plot_bgcolor = 'white'
  )

```



