---
title: "Topic detection"
author: "Mariateresa Russo"
date: "2025-05-31"
output: html_document
---
```{r}
library(knitr) 
library(kableExtra) 
library(DT)
library(tm)
library(topicmodels)
library(reshape2)
library(ggplot2)
library(wordcloud)
library(pals)
library(SnowballC)
library(lda)
library(flextable)
```

Lettura del Corpus
Term Document Matrix
```{r}
# Trova tutte le colonne presenti in entrambi i dataframe
all_cols <- union(names(final_df_threads), names(final_df_comments))

# Aggiungi le colonne mancanti in final_df, con valore 0
for (col in setdiff(all_cols, names(final_df_threads))) {
  final_df_threads[[col]] <- 0
}
# Aggiungi le colonne mancanti in final_df2, con valore 0
for (col in setdiff(all_cols, names(final_df_comments))) {
  final_df_comments[[col]] <- 0
}
# Riordina le colonne in entrambi i dataframe per avere lo stesso ordine
final_df <- final_df_threads[ , all_cols]
final_df2 <- final_df_comments[ , all_cols]
# Concatena con rbind
final_df_combined <- rbind(final_df_threads, final_df_comments)

final_df_threads
final_df_comments
final_df_combined

DTM <- final_df_combined
```

rimozione documenti vuoti
```{r}
sel_idx <- slam::row_sums(DTM) > 0
DTM <- DTM[sel_idx, ]
DTM <- as.matrix(DTM)
```


LDA prediction
```{r}
set.seed(9161)
# compute the LDA model, inference via 1000 iterations of Gibbs sampling
topicModel <- LDA(DTM, 3, method="Gibbs", control=list(iter = 500, verbose = 25))
topicModel
```

```{r}
tmResult <- posterior(topicModel)
attributes(tmResult)

# for every document we have a probability distribution of its contained topics
theta <- tmResult$topics 
dim(theta)

terms(topicModel, 20)

tmResult$topics %>% head(20)
```

parole chiave per topic
beta ti dice, per ogni topic, quanto è probabile ciascuna parola del vocabolario
```{r}
topics <- tidy(topicModel, matrix = "beta")  # beta = probabilità parola|topic

top_terms <- topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 20) %>%
  ungroup() %>%
  arrange(topic, -beta)

# Visualizzazione semplice
top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_x_reordered() +
  coord_flip() +
  labs(title = "Top terms per topic", x = "", y = "Beta (importance)")

```
Ecco i 3 topic rilevati:

Rosso --> Alimentazione, salute e pazienti

Verde --> Parole molto colloquiali e soggettive. Opinioni personali, atteggiamenti o esperienze

Blu --> Carriera professionale nel campo della dietetica



```{r}
Threads <- read_csv("Threads.csv")
Comments <- read_csv("Comments.csv")
```

Cerco i termini comuni tra la prima community e il primo topic
```{r}
library(tidyverse)
threads_mod_0 <- Threads %>%
  filter(modularity_class == 0)

comments_mod_0 <- Comments %>%
  filter(modularity_class == 0)

topic1_filtered <- top_terms %>%
  filter(topic == 1)

common_ids_thr0 <- threads_mod_0$Id[threads_mod_0$Id %in% topic1_filtered$term]

common_ids_comm0 <- comments_mod_0$Id[comments_mod_0$Id %in% topic1_filtered$term]


topic_1_thr = Threads %>%
  filter(Id %in% common_ids_thr0) %>%
  select(Id, pageranks)

topic_1_comm = Comments %>%
  filter(Id %in% common_ids_comm0) %>%
  select(Id, pageranks)

ggplot(topic_1_thr[1:7,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Topic 1 (Threads)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(topic_1_comm[1:8,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "red") +
  labs(
    title = "Topic 1 (Comments)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


Cerco i termini comuni tra la seconda community e il secondo topic
```{r}
threads_mod_1 <- Threads %>%
  filter(modularity_class == 1)

comments_mod_1 <- Comments %>%
  filter(modularity_class == 1)

topic2_filtered <- top_terms %>%
  filter(topic == 2)

common_ids_thr1 <- threads_mod_1$Id[threads_mod_1$Id %in% topic2_filtered$term]

common_ids_comm1 <- comments_mod_1$Id[comments_mod_1$Id %in% topic2_filtered$term]

topic_2_thr = Threads %>%
  filter(Id %in% common_ids_thr1) %>%
  select(Id, pageranks)

topic_2_comm = Comments %>%
  filter(Id %in% common_ids_comm1) %>%
  select(Id, pageranks)

ggplot(topic_2_thr[1:8,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Topic 2 (Threads)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(topic_2_comm[1:10,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "red") +
  labs(
    title = "Topic 2 (Comments)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


Cerco i termini comuni tra la terza community e il terzo topic
```{r}
threads_mod_2 <- Threads %>%
  filter(modularity_class == 2)

comments_mod_2 <- Comments %>%
  filter(modularity_class == 2)

topic3_filtered <- top_terms %>%
  filter(topic == 3)


common_ids_thr2 <- threads_mod_2$Id[threads_mod_2$Id %in% topic3_filtered$term]

common_ids_comm2 <- comments_mod_2$Id[comments_mod_2$Id %in% topic3_filtered$term]

topic_3_thr = Threads %>%
  filter(Id %in% common_ids_thr2) %>%
  select(Id, pageranks)

topic_3_comm = Comments %>%
  filter(Id %in% common_ids_comm2) %>%
  select(Id, pageranks)



ggplot(topic_3_thr[1:10,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Topic 3 (Threads)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(topic_3_comm[1:5,], aes(x = reorder(as.factor(Id), -pageranks), y = pageranks)) +
  geom_bar(stat = "identity", fill = "red") +
  labs(
    title = "Topic 3 (Comments)",
    x = "Term",
    y = "Pagerank"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



